relationships:
  # Primary relationship: Match by service.name and host.port
  - name: apmApplicationCallsInfraOracleDbInstance
    version: "1"
    origins:
      - APM Metrics
    conditions:
      - attribute: metricName
        # APM reports: "datastore/instance/Oracle/$service_name/$port"
        # Example: "Datastore/instance/Oracle/orcl-db.privatesubnet.oracledb.oraclevcn.com/1521"
        # The service name in APM metric should match the OTEL Oracle entity's service.name tag
        startsWith: "datastore/instance/Oracle/"
    relationship:
      expires: PT75M
      relationshipType: CALLS
      source:
        extractGuid:
          attribute: entity.guid
      target:
        lookupGuid:
          candidateCategory: ORACLEDBINSTANCE
          fields:
            # Matches against the OTEL Oracle entity's service.name tag
            # This is the Oracle service name from the connection string
            - field: serviceName
              attribute: metricName__4 # service name from APM metric
            - field: hostPort
              attribute: metricName__5 # port from APM metric

  # Fallback relationship: Match by host and port when service name doesn't match
  - name: apmApplicationCallsInfraOracleDbInstanceByHost
    version: "1"
    origins:
      - APM Metrics
    conditions:
      - attribute: metricName
        # APM reports: "datastore/instance/Oracle/$host/$port"
        # This is a fallback when service.name doesn't match but host does
        startsWith: "datastore/instance/Oracle/"
    relationship:
      expires: PT75M
      relationshipType: CALLS
      source:
        extractGuid:
          attribute: entity.guid
      target:
        lookupGuid:
          candidateCategory: ORACLEDBINSTANCE
          fields:
            # Matches against the OTEL Oracle entity's host.address tag
            - field: hostAddress
              attribute: metricName__4 # host from APM metric
            - field: hostPort
              attribute: metricName__5 # port from APM metric