domain: INFRA
type: MSSQLINSTANCE

synthesis:
  rules:
    - ruleName: infra_mssqlinstance_entityId
      identifier: entityId
      name: entityName
      legacyFeatures:
        useNonStandardAttributes: true
        overrideGuidType: true
      prefixedTags:
        label.:
          ttl: PT4H
      conditions:
        - attribute: event_type
          value: "MssqlInstanceSample"
      tags:
        integrationName:
          ttl: P1D
        integrationVersion:
          ttl: P1D
        reportingAgent:
          ttl: P1D
        entityKey:
          ttl: P1D

    - ruleName: infra_mssqlinstance_execution_plan
      identifier: server.address
      name: server.address
      encodeIdentifierInGUID: true
      conditions:
        - attribute: newrelic.event.type
          value: SqlServerExecutionPlan
        - attribute: instrumentation.provider
          value: opentelemetry
        - attribute: otel.library.name
          value: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/newrelicsqlserverreceiver
      tags:
        otel.library.name:
          entityTagName: instrumentation.name
        telemetry.sdk.name:
          entityTagName: instrumentation.provider
        server.address:
          entityTagName: server.address
        server.port:
          entityTagName: server.port
        sql.version:
          entityTagName: database.version
        db.hostname:
          entityTagName: db.hostname
    - ruleName: infra_mssqlinstance_query_details
      identifier: server.address
      name: server.address
      encodeIdentifierInGUID: true
      conditions:
        - attribute: newrelic.event.type
          value: SqlServerSlowQueryDetails
        - attribute: instrumentation.provider
          value: opentelemetry
        - attribute: otel.library.name
          value: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/newrelicsqlserverreceiver
      tags:
        otel.library.name:
          entityTagName: instrumentation.name
        telemetry.sdk.name:
          entityTagName: instrumentation.provider
        server.address:
          entityTagName: server.address
        server.port:
          entityTagName: server.port
        sql.version:
          entityTagName: database.version
        db.hostname:
          entityTagName: db.hostname
    - ruleName: infra_mssqlinstance_server_address
      identifier: server.address
      name: server.address
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: Metric
        - attribute: metricName
          prefix: sqlserver.
        - attribute: instrumentation.provider
          value: opentelemetry
        - attribute: otel.library.name
          value: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/newrelicsqlserverreceiver
      tags:
        otel.library.name:
          entityTagName: instrumentation.name
        telemetry.sdk.name:
          entityTagName: instrumentation.provider
        server.address:
          entityTagName: server.address
        server.port:
          entityTagName: server.port
        sql.version:
          entityTagName: database.version
        db.hostname:
          entityTagName: db.hostname
goldenTags:
  - mssql.host
  - mssql.instance
configuration:
  entityExpirationTime: DAILY
  alertable: true

dashboardTemplates:
  # This should match the entity created from the ohi in the infra pipeline
  newRelic:
    template: newrelic_dashboard.json
  opentelemetry:
    template: newrelic_otel_sql_dashboard.json

ownership:
  primaryOwner:
    teamName: "Database Integrations"
