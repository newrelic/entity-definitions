domain: EXT
type: ISTIO_SERVICE
goldenTags:
  - k8s.clusterName
  - k8s.namespaceName

synthesis:
  rules:
    # prometheus
    - ruleName: ext_istio_service_composite_stg
      compositeIdentifier:
        separator: ":"
        attributes:
          - cluster_name
          - service_istio_io_canonical_name
      encodeIdentifierInGUID: true
      name: service_istio_io_canonical_name
      conditions:
        - attribute: metricName
          prefix: istio_request
        - attribute: instrumentation.provider
          value: prometheus
    - ruleName: ext_istio_service_composite_stg_2
      compositeIdentifier:
        separator: ":"
        attributes:
          - cluster_name
          - service_istio_io_canonical_name
      encodeIdentifierInGUID: true
      name: service_istio_io_canonical_name
      conditions:
        - attribute: metricName
          prefix: istio_response
        - attribute: instrumentation.provider
          value: prometheus
    # otel
    - ruleName: ext_istio_service_composite_stg_3
      compositeIdentifier:
        separator: ":"
        attributes:
          - k8s.cluster.name
          - k8s.pod.label.service.istio.io/canonical-name
      encodeIdentifierInGUID: true
      name: k8s.pod.label.service.istio.io/canonical-name
      conditions:
        - attribute: metricName
          prefix: istio_request
        - attribute: instrumentation.provider
          value: opentelemetry
    - ruleName: ext_istio_service_composite_stg_4
      compositeIdentifier:
        separator: ":"
        attributes:
          - k8s.cluster.name
          - k8s.pod.label.service.istio.io/canonical-name
      encodeIdentifierInGUID: true
      name: k8s.pod.label.service.istio.io/canonical-name
      conditions:
        - attribute: metricName
          prefix: istio_response
        - attribute: instrumentation.provider
          value: opentelemetry

  tags:
    # prometheus
    cluster_name:
      entityTagName: k8s.clusterName
      ttl: P1D
    deployment:
      entityTagName: k8s.deploymentName
      ttl: P1D
    namespace:
      entityTagName: k8s.namespaceName
      ttl: P1D
    pod:
      entityTagName: k8s.podName
      ttl: P1D

    # otel
    k8s.cluster.name:
      entityTagName: k8s.clusterName
      ttl: P1D
    k8s.deployment.name:
      entityTagName: k8s.deploymentName
      ttl: P1D
    k8s.namespace.name:
      entityTagName: k8s.namespaceName
      ttl: P1D
    k8s.pod.name:
      entityTagName: k8s.podName
      ttl: P1D

    service_istio_io_canonical_revision:
    app:
    version:
    label.istio:
    istio_io_rev:
    operator_istio_io_component:

dashboardTemplates:
  newRelic:
    template: dashboard.json
  prometheus:
    template: dashboard.json
  opentelemetry:
    template: opentelemetry_dashboard.json

configuration:
  entityExpirationTime: FOUR_HOURS
  alertable: true

ownership:
  primaryOwner:
    teamName: "no owner"
