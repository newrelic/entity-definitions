incomingMessagesPerSecond:
  title: Incoming messages per second
  unit: OPERATIONS_PER_SECOND
  queries:
    newRelic:
      select: average(broker.messagesInPerSecond)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: sum(kafka.message.count) / sum((endTimestamp - timestamp) / 1000)
      from: Metric
      where: metricName = 'kafka.message.count'
      eventId: entity.guid

bytesInPerSecond:
  title: Bytes in per second
  unit: BYTES_PER_SECOND
  queries:
    newRelic:
      select: average(broker.IOInPerSecond)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: sum(kafka.network.io) / sum((endTimestamp - timestamp) / 1000)
      from: Metric
      where: metricName = 'kafka.network.io' AND (state = 'in' OR direction = 'in')
      eventId: entity.guid

bytesPerOutSecond:
  title: Bytes out per second
  unit: BYTES_PER_SECOND
  queries:
    newRelic:
      select: average(broker.IOOutPerSecond)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: sum(kafka.network.io) / sum((endTimestamp - timestamp) / 1000)
      from: Metric
      where: metricName = 'kafka.network.io' AND (state = 'out' OR direction = 'out')
      eventId: entity.guid

underReplicatedPartitions:
  title: Under-replicated partitions
  unit: COUNT
  queries:
    newRelic:
      select: max(replication.unreplicatedPartitions)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: max(kafka.partition.under_replicated)
      from: Metric
      where: metricName = 'kafka.partition.under_replicated'
      eventId: entity.guid

produceRequestLatency99p:
  title: Produce request latency (99th percentile)
  unit: MS
  queries:
    newRelic:
      select: average(request.produceTime99Percentile)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: average(`kafka.request.time.99p`)
      from: Metric
      where: metricName = 'kafka.request.time.99p' AND type = 'Produce'
      eventId: entity.guid

produceRequestsFailedPerSecond:
  title: Failed produce requests per second
  unit: OPERATIONS_PER_SECOND
  queries:
    newRelic:
      select: average(request.produceRequestsFailedPerSecond)
      from: KafkaBrokerSample
      eventId: entityGuid
      eventName: entityName
    opentelemetry:
      select: sum(kafka.request.failed) / sum((endTimestamp - timestamp) / 1000)
      from: Metric
      where: metricName = 'kafka.request.failed' AND type = 'produce'
      eventId: entity.guid